<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - DriveSafe</title>
    <link rel="stylesheet" href="../../assets/css/themes.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="auth-body">
    <div class="auth-container">
        <div class="auth-wrapper single-form">
            <div class="auth-form-container">
                <div class="auth-form">
                    <!-- Back Button -->
                    <div class="form-back">
                        <button class="btn-back" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Login</span>
                        </button>
                    </div>

                    <!-- Logo -->
                    <div class="form-logo">
                        <div class="logo-large">
                            <i class="fas fa-car-side"></i>
                            <h1>DriveSafe</h1>
                        </div>
                    </div>

                    <!-- Step 1: Email/Phone Input -->
                    <div id="step1" class="reset-step active">
                        <div class="form-header">
                            <h3>Reset Password</h3>
                            <p>Enter your email or phone number and we'll send you instructions to reset your password.</p>
                        </div>

                        <form id="forgotPasswordForm" class="forgot-form">
                            <div class="form-group">
                                <label for="resetEmail">
                                    <i class="fas fa-envelope"></i>
                                    Email or Phone Number
                                </label>
                                <input type="text" id="resetEmail" name="email" placeholder="Enter your email or phone number" required>
                                <span class="error-message" id="emailError"></span>
                            </div>

                            <button type="submit" class="btn-primary btn-full" id="sendResetButton">
                                <span class="btn-text">Send Reset Instructions</span>
                                <span class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>

                            <div class="form-error" id="forgotError" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="forgotErrorMessage"></span>
                            </div>
                        </form>

                        <!-- Alternative Options -->
                        <div class="reset-options">
                            <div class="divider">
                                <span>or</span>
                            </div>
                            <div class="option-buttons">
                                <button class="btn-option" onclick="showStep('phone')">
                                    <i class="fas fa-sms"></i>
                                    <span>Reset via SMS</span>
                                </button>
                                <button class="btn-option" onclick="showStep('security')">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Security Questions</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: SMS Reset -->
                    <div id="stepPhone" class="reset-step">
                        <div class="form-header">
                            <h3>SMS Verification</h3>
                            <p>Enter your phone number to receive a verification code via SMS.</p>
                        </div>

                        <form id="smsResetForm" class="sms-form">
                            <div class="form-group">
                                <label for="phoneNumber">
                                    <i class="fas fa-phone"></i>
                                    Phone Number
                                </label>
                                <div class="phone-input">
                                    <select id="smsCountryCode" name="countryCode">
                                        <option value="+977">ðŸ‡³ðŸ‡µ +977</option>
                                    </select>
                                    <input type="tel" id="phoneNumber" name="phone" placeholder="98XXXXXXXX" required>
                                </div>
                                <span class="error-message" id="phoneError"></span>
                            </div>

                            <button type="submit" class="btn-primary btn-full" id="sendSmsButton">
                                <span class="btn-text">Send SMS Code</span>
                                <span class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </form>

                        <button class="btn-secondary btn-full" onclick="showStep('1')">
                            Back to Email Reset
                        </button>
                    </div>

                    <!-- Step 3: Verification Code -->
                    <div id="step2" class="reset-step">
                        <div class="form-header">
                            <h3>Enter Verification Code</h3>
                            <p id="verificationMessage">We've sent a verification code to your email.</p>
                        </div>

                        <form id="verifyCodeForm" class="verify-form">
                            <div class="form-group">
                                <label for="verificationCode">
                                    <i class="fas fa-key"></i>
                                    Verification Code
                                </label>
                                <div class="code-input">
                                    <input type="text" class="code-digit" maxlength="1" required>
                                    <input type="text" class="code-digit" maxlength="1" required>
                                    <input type="text" class="code-digit" maxlength="1" required>
                                    <input type="text" class="code-digit" maxlength="1" required>
                                    <input type="text" class="code-digit" maxlength="1" required>
                                    <input type="text" class="code-digit" maxlength="1" required>
                                </div>
                                <span class="error-message" id="codeError"></span>
                            </div>

                            <div class="resend-section">
                                <p>Didn't receive the code?</p>
                                <button type="button" class="btn-link" id="resendButton" onclick="resendCode()">
                                    Resend Code (<span id="resendTimer">60</span>s)
                                </button>
                            </div>

                            <button type="submit" class="btn-primary btn-full" id="verifyButton">
                                <span class="btn-text">Verify Code</span>
                                <span class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </form>

                        <button class="btn-secondary btn-full" onclick="showStep('1')">
                            Try Different Method
                        </button>
                    </div>

                    <!-- Step 4: New Password -->
                    <div id="step3" class="reset-step">
                        <div class="form-header">
                            <h3>Create New Password</h3>
                            <p>Enter your new password below. Make sure it's strong and secure.</p>
                        </div>

                        <form id="newPasswordForm" class="new-password-form">
                            <div class="form-group">
                                <label for="newPassword">
                                    <i class="fas fa-lock"></i>
                                    New Password
                                </label>
                                <div class="password-input">
                                    <input type="password" id="newPassword" name="password" placeholder="Enter new password" required>
                                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="newStrengthFill"></div>
                                    </div>
                                    <span class="strength-text" id="newStrengthText">Password Strength</span>
                                </div>
                                <span class="error-message" id="newPasswordError"></span>
                            </div>

                            <div class="form-group">
                                <label for="confirmNewPassword">
                                    <i class="fas fa-lock"></i>
                                    Confirm New Password
                                </label>
                                <div class="password-input">
                                    <input type="password" id="confirmNewPassword" name="confirmPassword" placeholder="Confirm new password" required>
                                    <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <span class="error-message" id="confirmNewPasswordError"></span>
                            </div>

                            <button type="submit" class="btn-primary btn-full" id="resetPasswordButton">
                                <span class="btn-text">Reset Password</span>
                                <span class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Step 5: Success -->
                    <div id="stepSuccess" class="reset-step success-step">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="form-header">
                            <h3>Password Reset Successful!</h3>
                            <p>Your password has been successfully reset. You can now log in with your new password.</p>
                        </div>

                        <button class="btn-primary btn-full" onclick="window.location.href='login.html'">
                            <i class="fas fa-sign-in-alt"></i>
                            Go to Login
                        </button>
                    </div>

                    <!-- Login Link -->
                    <div class="auth-switch">
                        <p>Remember your password? 
                            <a href="login.html">Sign in here</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../config/constants.js"></script>
    <script src="../../config/api-endpoints.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/main.js"></script>

    <script>
        let resendTimer = 60;
        let resendInterval;

        document.addEventListener('DOMContentLoaded', function() {
            initializeForgotPassword();
            
            // Code input auto-focus
            const codeInputs = document.querySelectorAll('.code-digit');
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1 && index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });

            // Password strength checker
            document.getElementById('newPassword').addEventListener('input', function() {
                checkPasswordStrength(this.value, 'new');
            });
        });

        function showStep(step) {
            document.querySelectorAll('.reset-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            
            if (step === '2') {
                startResendTimer();
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentElement.querySelector('.password-toggle i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function checkPasswordStrength(password, prefix = '') {
            const strengthFill = document.getElementById(prefix + 'StrengthFill');
            const strengthText = document.getElementById(prefix + 'StrengthText');
            
            let strength = 0;
            let text = 'Weak';
            let color = '#dc3545';

            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            switch(strength) {
                case 0:
                case 1:
                    text = 'Very Weak';
                    color = '#dc3545';
                    break;
                case 2:
                    text = 'Weak';
                    color = '#fd7e14';
                    break;
                case 3:
                    text = 'Fair';
                    color = '#ffc107';
                    break;
                case 4:
                    text = 'Good';
                    color = '#20c997';
                    break;
                case 5:
                    text = 'Strong';
                    color = '#28a745';
                    break;
            }

            strengthFill.style.width = (strength * 20) + '%';
            strengthFill.style.backgroundColor = color;
            strengthText.textContent = text;
            strengthText.style.color = color;
        }

        function startResendTimer() {
            const button = document.getElementById('resendButton');
            const timer = document.getElementById('resendTimer');
            
            button.disabled = true;
            resendTimer = 60;
            
            resendInterval = setInterval(() => {
                resendTimer--;
                timer.textContent = resendTimer;
                
                if (resendTimer <= 0) {
                    clearInterval(resendInterval);
                    button.disabled = false;
                    button.innerHTML = 'Resend Code';
                }
            }, 1000);
        }

        function resendCode() {
            // API call to resend code
            showToast('Verification code sent again!', 'success');
            startResendTimer();
        }
    </script>
</body>
</html>